<!DOCTYPE html>
<html lang="en">
<head>
  <title>University of Victoria 3D Buildings</title>
  <meta property="og:description" content="Display 3D buildings at the University of Victoria, BC." />
  <meta charset='utf-8'>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel='stylesheet' href='https://unpkg.com/maplibre-gl@4.5.1/dist/maplibre-gl.css' />
  <script src='https://unpkg.com/maplibre-gl@4.5.1/dist/maplibre-gl.js'></script>
  <style>
      body { margin: 0; padding: 0; }
      html, body, #map { height: 100%; }
  </style>
</head>
<body>
<div id="map"></div>
<script>
  const MAPTILER_KEY = 'get_your_own_OpIi9ZULNHzrESv6T2vL';
  const BOUNDS = [
      [-123.3350, 48.4480], // Southwest bound (near Cadboro Bay)
      [-123.2940, 48.4780]  // Northeast bound (near Gordon Head)
];

  const map = new maplibregl.Map({
      style: `https://api.maptiler.com/maps/basic-v2/style.json?key=${MAPTILER_KEY}`,
      center: [-123.31181, 48.4624],
      zoom: 16.1,
      opacity: 0.85,
      pitch: 48,
      bearing: -9.6,
      container: 'map',
      antialias: true,
      maxBounds: BOUNDS,
      minZoom: 15.5,
      maxZoom: 18,
  });

  // The 'building' layer in the streets vector source contains building-height
  // data from OpenStreetMap.
  map.on('load', () => {
      // Insert the layer beneath any symbol layer.

      if (map.getLayer('Other border')) { 
          map.removeLayer('Other border');
      }
    //   // 2. Add a mask to fade the area around UVic to a white void // cant get this to work // TODO: fade to white around border
    //   map.addSource('fade-mask', {
    //       'type': 'geojson',
    //       'data': {
    //           'type': 'FeatureCollection',
    //           'features': [
    //               {
    //                   'type': 'Feature',
    //                   'geometry': {
    //                       'type': 'Point',
    //                       'coordinates': UVIC_COORDINATES
    //                   }
    //               }
    //           ]
    //       }
    //   });

    //   map.addLayer({
    //       'id': 'fade-mask',
    //       'type': 'circle',
    //       'source': 'fade-mask',
    //       'paint': {
    //           'circle-radius': [
    //               'interpolate',
    //               ['linear'],
    //               ['zoom'],
    //               10, RADIUS * 2, // Radius in meters for zoom level 10
    //               16, RADIUS // Radius in meters for zoom level 16
    //           ],
    //           'circle-color': '#ffffff',
    //           'circle-opacity': [
    //               'interpolate',
    //               ['linear'],
    //               ['circle-radius'],
    //               RADIUS, 0,
    //               RADIUS * 2, 1
    //           ]
    //       }
    //   });

    //   // 3. Add a panning effect when the website is first opened
    //   map.flyTo({
    //       center: UVIC_COORDINATES,
    //       zoom: 18,
    //       speed: 0.5, // Lower speed for a smoother effect
    //       curve: 1, // Control the smoothness of the curve (1 is default)
    //       easing: t => t, // Easing function (linear by default)
    //       essential: true
    //   });

      const layers = map.getStyle().layers;
      let labelLayerId;
      for (let i = 0; i < layers.length; i++) {
        

          if (layers[i].type === 'symbol' && layers[i].layout['text-field']) {
              labelLayerId = layers[i].id;
              break;
          }
      }

      map.addSource('openmaptiles', {
          url: `https://api.maptiler.com/tiles/v3/tiles.json?key=${MAPTILER_KEY}`,
          type: 'vector',
      });

      map.addLayer( /// TODO: background sattelite layer
          {
              'id': 'Satellite',
              'source': 'satellite-v2',
              'source-layer': 'building',
              'type': 'raster',

              'filter': ['!=', ['get', 'hide_3d'], true],
                'paint': {
                    'raster-opacity': 0.85
                }
          },
          labelLayerId
      );


      map.addLayer(
          {
              'id': '3d-buildings',
              'source': 'openmaptiles',
              'source-layer': 'building',
              'type': 'fill-extrusion',
              'minzoom': 15,
              'filter': ['!=', ['get', 'hide_3d'], true],
              'paint': {
                  'fill-extrusion-color': [
                      'interpolate',
                      ['linear'],
                      ['get', 'render_height'], 0, 'lightgray', 200, 'royalblue', 400, 'lightblue'
                  ],
                  'fill-extrusion-height': [
                      'interpolate',
                      ['linear'],
                      ['zoom'],
                      15,
                      0,
                      16,
                      ['get', 'render_height']
                  ],
                  'fill-extrusion-base': ['case',
                      ['>=', ['get', 'zoom'], 16],
                      ['get', 'render_min_height'], 0
                  ]
              }
          },
          labelLayerId
      );
  });
</script>
</body>
</html>